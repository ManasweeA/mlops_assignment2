name: CD
on:
  push: {branches: [main]}
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: azure/setup-kubectl@v4
      with: {version: 'latest'}
    - uses: azure/k8s-set-context@v4
      with:
        method: minikube  # Or use kind for CI
    - run: |
        kubectl set image deployment/cats-dogs-api api=<dockerhub>/cats-dogs-api:latest
        kubectl rollout status deployment/cats-dogs-api
    - name: Smoke Test
      run: |
        minikube service cats-dogs-service --url
        curl $(minikube service cats-dogs-service --url)/health || exit 1